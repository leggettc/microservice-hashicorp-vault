const constants = require('../../config/constants');
const db = global.mongo;
const {serr} = require('../../modules/singularError');
const myCollection = db.collection(constants.appUsersTable);
const {getRecoveryCodes, filterSensitiveDataFromCredential} = require('../../modules/util');

const getUserByUserId = (userId,companyId,connectionId) => {
  return new Promise((resolve,reject) => {
    myCollection.findOne({userId,'_id.companyId':companyId}, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      const userInfo = filterSensitiveDataFromCredential(response);
      resolve(userInfo)
    })
  })
}

const incrementVariable = (userId,companyId,key,value) =>{
  const query = {userId,'_id.companyId':companyId};

  const variablesKey = `variables.${key}`
  const update = {$inc:{}}
  update.$inc[variablesKey] = value
  return new Promise((resolve,reject) => {
    myCollection.findAndModify({query,update,new:true}, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response);
    })
  })
}


const saveVariable = (userId,companyId,key,value) =>{
  const query = {userId,'_id.companyId':companyId};

  let variablesKey = `variables.${key}`
  const update = {$set:{}}
  update.$set[variablesKey] = value

  return new Promise((resolve,reject) => {
    myCollection.findAndModify({query,update,new:true}, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response);
    })
  })
}

const createCredential = ({
  userId,
  companyId,
  credential,
  uniqueProperties,
}) => {
  if (credential && !credential.createdDate) {
    credential.createdDate = Date.now();
  }
  const user = { userId, '_id.companyId': companyId };

  const update = {
    $push: {
      credentials: { ...credential },
    },
  };

  if (!uniqueProperties) {
    return new Promise((resolve, reject) => {
      myCollection.findAndModify(
        { query: user, update, new: true },
        (err, response) => {
          if (err) {
            console.log(err);
            return reject(err);
          }
          resolve(response);
        }
      );
    });
  } else {
    let credFilter = { ...user };
    uniqueProperties.map((k) => {
      const key = `credentials.${k.key}`;
      credFilter[key] = `${k.value}`;
    });

    return new Promise((resolve, reject) => {
      myCollection.find(credFilter, (err, response) => {
        if (err) {
          console.log(err);
          return reject(err);
        }
        if (response && response.length > 0) {
          return reject(
            new serr('CreadentialExistError', {
              message: 'Credential Already Exists',
            })
          );
        }
        myCollection.findAndModify(
          { query: user, update, new: true },
          (err, response) => {
            if (err) {
              console.log(err);
              return reject(err);
            }
            resolve(response);
          }
        );
      });
    });
  }
};
const saveVariables = (userId,companyId,props) =>{
  const query = {userId,'_id.companyId':companyId};

  const update = {$set:{}}
  Object.keys(props).forEach(key=>{
    let variablesKey = `variables.${key}`
    update.$set[variablesKey] = props[key]
  })

  return new Promise((resolve,reject) => {
    myCollection.findAndModify({query,update,new:true}, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response);
    })
  })
}

const deleteCredential = ({userId,companyId,credId}) => {
  const query = {userId, '_id.companyId': companyId};

  const update = {
    $pull: {
      credentials: {
        credId: credId
      }
    }
  };

  return new Promise((resolve, reject) => {
    myCollection.update(query, update, (err, response) => {
      if (err) {
        console.log(err);
        return reject(err)
      }
      resolve(response)
    })
  })
}


const updateCredential = ({userId,companyId,credId,status,customFields}) => {

  const query = {userId,'_id.companyId':companyId,
    "credentials.credId": credId
  };

  const update = {}

  if(status){
    if(!update['$set']) update['$set'] = {}
    update['$set']['credentials.$.status']  = status
  }

  if(customFields && Object.keys(customFields).length > 0){
    if(!update['$set']) update['$set'] = {}
    Object.keys(customFields).forEach(k=>{
      update['$set'][`credentials.$.details.raw.${k}`]  = customFields[k]
    })
  }

  return new Promise((resolve,reject) => {
    myCollection.findAndModify({query,update,new:true}, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response);
    })
  })
}

const getUserByAlias = (companyId,userAlias) => {

  return new Promise((resolve,reject) => {
    myCollection.findOne({userAlias,"_id.companyId":companyId}, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      const userInfo = filterSensitiveDataFromCredential(response);
      resolve(userInfo)
    })
  })
}

const getUserByConnectionIdEmail = (companyId,connectionId,email) => {

  return new Promise((resolve,reject) => {
    myCollection.findOne({email,"_id.companyId":companyId,"_id.connectionId":connectionId}, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      const userInfo = filterSensitiveDataFromCredential(response);
      resolve(userInfo)
    })
  })
}

const getUser = (companyId,connectionId,username) => {
  let props = {_id:{username,companyId,connectionId}}
  return new Promise((resolve,reject) => {
    myCollection.findOne(props, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      const userInfo = filterSensitiveDataFromCredential(response);
      resolve(userInfo)
    })
  })
}

const updateUser = (userId,companyId,props,passwordHistoryProps) => {
  const user = {userId,'_id.companyId':companyId}
  const update = {
    $set: props
  };

  if(passwordHistoryProps && passwordHistoryProps.previousPassword){
    update.$push = {
      passwordHistory: {
        $each:[passwordHistoryProps.previousPassword],
        $slice: -passwordHistoryProps.totalPreviousPasswordsCount
      }
    }
  }

  return new Promise((resolve,reject) => {
    myCollection.findAndModify({query:user,update,new:true}, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response);
    });
  });
};

const getUserRecoveryCodes = (userId,companyId) => {
  return new Promise((resolve,reject) => {
    myCollection.findOne({userId,'_id.companyId':companyId}, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      const recoveryCodes = getRecoveryCodes(response);
      resolve(recoveryCodes)
    })
  })
}

module.exports = {
  getUserByUserId,
  incrementVariable,
  saveVariable,
  createCredential,
  saveVariables,
  deleteCredential,
  updateCredential,
  getUserByConnectionIdEmail,
  getUser,
  updateUser,
  getUserByAlias,
  getUserRecoveryCodes
}