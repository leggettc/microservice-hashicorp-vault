/**
 * Created by hiteshkalra on 8/27/18.
 */


const _ = require('lodash'),
constants = require('../../config/constants');

const collectionName = constants.eventsTable;
const db = global.mongoDB;
const myCollection = db.collection(collectionName);


const createEvent = (props) => {
  const event = {
    _id: props.eventId,
    ...props,
    createdDate: Date.now()
  }
  if (event.details) {
    event.details = JSON.stringify(event.details)
  }

  return new Promise((resolve,reject) => {
    myCollection.insertOne(event, (err,response) =>{
      if(err) {
        console.log (err);
        return reject(err)
      }
      resolve(event)
    })
  })
}

const getEvent = (eventId) => {
  const query = {_id: eventId};
  
  return new Promise((resolve, reject) => {
    myCollection.findOne(query, (err, response) => {
      if (err) {
        console.log(err);
        return reject(err)
      }
      if (response && response.details) {
        try {
          response.details = JSON.parse(response.details)
        } catch(err) {
          console.log("FYI - error parsing response")
        }
      }
      resolve(response)
    })
  })
}

const updateEventStatus = (eventId,status,updatedBy,props) => {

  const query = {_id: eventId};
  const update = {
    $set: {status:status,statusUpdatedDate: Date.now(),statusUpdatedBy:updatedBy,...props}
  };
  const options = {
    returnDocument: 'before'
  };

  return new Promise((resolve,reject) => {
    myCollection.findOneAndUpdate(query, update, options, (err,response)=>{
      if(err) {
        console.log(err);
        return reject(err);
      }
      resolve(response.value);
    })
  })
}

module.exports = {
  createEvent,
  getEvent,
  updateEventStatus

}