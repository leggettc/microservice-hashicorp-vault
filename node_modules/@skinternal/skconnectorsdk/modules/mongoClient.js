const {logger} = require('@skinternal/sk-logger');
// const mongojs = require('mongojs');
const { MongoClient } = require('mongodb');
const _ = require('lodash')
let uri = '';
global.mongoDB = '';

const initialize = async () =>{

  let {username,password,uri,usePath,dbName} = global.secrets.db || {}
  if(usePath && global.partnerSecrets){
    logger.info('db usePath')
    username = _.get(global.partnerSecrets,username,'')
    password = _.get(global.partnerSecrets,password,'')
    uri = _.get(global.partnerSecrets,uri,'')
  }
  logger.info('db info to Use',{username,uri,usePath})

  if(username === '') {
    uri = `mongodb://${uri}`;
  } else {
    uri = `mongodb://${username}:${password}@${uri}`;
  }
  try {
    const client = new MongoClient(uri);
    await client.connect();
    if(dbName){
      global.mongoDB = client.db(dbName);
    }else {
      global.mongoDB = client.db();
    }
    logger.info('Configured Mongo DB');
  } catch (err) {
    logger.error('Error connecting to Mongo DB');
    throw err;
  }
  // global.mongo = mongojs(uri);
  // logger.info('Configured Mongo DB')
};

module.exports = {
  initialize,
};
