pipelines:
  branches:
   dev:
    - step:
          name: synopsys-detect
          image: openjdk:11
          services:
            - docker
          script:
          - bash <(curl -s https://detect.synopsys.com/detect.sh) --blackduck.url="${BLACKDUCK_URL}" --blackduck.api.token="${BLACKDUCK_TOKEN}" --detect.project.version.name=${BITBUCKET_BRANCH}
    - step: &sonarcloud
          name: Sonar
          script:
            - pipe: sonarsource/sonarcloud-scan:1.2.0
            - pipe: sonarsource/sonarcloud-quality-gate:0.1.3
              variables:
                SONAR_TOKEN: ${SONAR_TOKEN}
                EXTRA_ARGS: -Dsonar.projectBaseDir=$(pwd)
    - step:
        name: Publish
        image: node:10.20.1
        deployment: dev-publish
        script:
          - printf "registry=https://verdaccio.singularkey.com/\n//verdaccio.singularkey.com/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          - cat ~/.npmrc
          - npm publish 
   master:
    - step: 
          name: Sonar
          script:
            - pipe: sonarsource/sonarcloud-scan:1.2.0
            - pipe: sonarsource/sonarcloud-quality-gate:0.1.3
              variables:
                SONAR_TOKEN: ${SONAR_TOKEN}
                EXTRA_ARGS: -Dsonar.projectBaseDir=$(pwd)
    - step:
        name: Publish
        image: node:10.20.1
        deployment: prod-publish
        script:
          - printf "registry=https://package.singularkey.com/\n//package.singularkey.com/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          - cat ~/.npmrc
          - npm publish
  pull-requests:
    '**':
      - step: *sonarcloud
